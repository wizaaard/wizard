name: website lint & run tests & deploy
on:
  push:
    paths:
      - 'client/**'
      - .github/**
  pull_request:
    paths:
      - 'client/**'
      - .github/**

jobs:
  run-tests-and-lint:
    name: lint and run test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: cache deps
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: install deps
        run: yarn install

      - name: run client unit tests use Jest
        run: yarn test
        working-directory: client

      - name: run lint
        run: yarn lint
        working-directory: client

      - name: run prettier checker
        run: yarn prettier-check:client

  upload-image:
    name: upload docker image to cloud
    needs: run-tests-and-lint
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v2

      - name: cache deps
        uses: actions/cache@v2
        env:
          cache-name: cache-node-modules
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

      - name: install deps
        run: yarn install

      - name: build client
        run: yarn build || yarn build
        working-directory: client

      - name: docker login
        run: docker login --username=${{ secrets.TENCENT_YUN_USERNAME }} --password ${{ secrets.TENCENT_YUN_PASSWORD }}

      - name: build docker image
        run: docker build -f ./Dockerfile.Client -t wizard_website ./client

      - name: tag the image & push the image to cloud
        run: |
          docker tag $(docker images -q --filter reference=wizard_website) ${{ secrets.WEBSITE_IMAGE_NAME }}
          docker push ${{ secrets.WEBSITE_IMAGE_NAME }}

  pull-image:
    needs: [upload-image]
    name: pull image from cloud
    runs-on: ubuntu-latest
    steps:
      - name: deploy website
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_SERVER_HOST }}
          username: ${{ secrets.DEPLOY_SERVER_USER }}
          password: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
          port: ${{ secrets.DEPLOY_SERVER_SSH_PORT }}
          script: |
            docker network create wizardoc_net
            docker login --username=${{ secrets.TENCENT_YUN_USERNAME }} --password ${{ secrets.TENCENT_YUN_PASSWORD }}
            docker stop ${{ secrets.WEBSITE_CONTAINER_NAME }}
            docker rm -f ${{ secrets.WEBSITE_CONTAINER_NAME }}
            docker rmi -f ${{ secrets.WEBSITE_IMAGE_NAME }}
            docker pull ${{ secrets.WEBSITE_IMAGE_NAME }}
            docker run --name ${{ secrets.WEBSITE_CONTAINER_NAME }} --network wizardoc_net -d -p 8060:80 ${{ secrets.WEBSITE_IMAGE_NAME }}
